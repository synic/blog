# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with
code in this repository.

## Project Overview

A personal blog (https://synic.dev) built with Go, Templ templates, HTMX,
TailwindCSS, and PostgreSQL. Articles are authored in Markdown with YAML
frontmatter, converted to JSON at build time, and served from memory.

## Common Commands

All build tasks use Mage (`go tool github.com/magefile/mage`):

| Command                    | Description                                    |
|----------------------------|------------------------------------------------|
| `mage`                     | Default: runs dev server with hot reload (Air) |
| `mage build:dev`           | Debug build with codegen, vet, article convert |
| `mage build:release`       | Production build (static binary, tests first)  |
| `mage codegen`             | Run sqlc, templ generate, and tailwind         |
| `mage sqlc`                | Regenerate database code from SQL queries      |
| `mage test`                | Run `go test -race ./...` (includes vet)       |
| `mage vet`                 | Run `go vet ./...`                             |
| `mage check`               | Full check: codegen, format, vet, test         |
| `mage db:migrate`          | Run goose migrations up                        |
| `mage db:rollback`         | Run goose migrations down                      |
| `mage articles:convert`    | Convert markdown articles to JSON              |
| `mage articles:reconvert`  | Reconvert all articles from scratch            |

Tools are invoked as `go tool <pkg>` (templ, air, goose) — no separate
installs needed. SQLC requires the `sqlc` binary on PATH.

## Architecture

**Request flow:** HTTP routes (`internal/routes.go`) → middleware stack →
controllers → stores → database (pgx/v5)

- **`internal/controller/`** — HTTP handlers. Controllers receive
  dependencies (stores, queries) via constructor injection.
- **`internal/store/`** — Data access layer. `ArticleRepository` loads
  articles from embedded JSON into memory. Comment and page view stores
  wrap sqlc-generated queries.
- **`internal/db/`** — Auto-generated by sqlc. Do not edit directly.
  Source queries live in `internal/db/queries/*.sql`.
- **`internal/view/`** — Templ templates (`.templ` files). Generated Go
  code is in `*_templ.go`. Layout, partials, and rendering helpers.
- **`internal/middleware/`** — Auth (session/user context), CSRF, HTMX
  partial detection, logging. Composed via `middleware.Wrap()`.
- **`internal/model/`** — Domain types (Article, Comment, User, etc.)
  and context data.
- **`internal/converter/`** — Markdown-to-HTML conversion pipeline using
  Goldmark with Chroma syntax highlighting.
- **`internal/mail/`** — Email notifications via Resend API.
- **`internal/config/`** — Config from env vars (`.env` in debug mode).

**Database:** PostgreSQL with goose migrations in `migrations/`. Schema
has users, sessions, comments, and page_views tables.

**Articles:** Markdown files in `articles/` with format
`YYYY-MM-DD_slug.md`. Converted to JSON in `assets/articles/` at build
time. Loaded into memory at startup with O(1) slug lookups.

**Static assets:** Embedded via Go's `embed` package. TailwindCSS input
is `internal/view/css/main.css`, output is `assets/css/main.css`.

## Code Generation Workflow

After modifying `.templ` files, SQL queries, or CSS: run `mage codegen`.
This runs sqlc, templ generate, and tailwind in sequence. Do not edit
`*_templ.go` or `internal/db/*.sql.go` files — they are generated.

## Key Conventions

- Standard library `net/http` router (Go 1.22+ pattern matching)
- Build tags: `debug` and `release` control behavior
- `ldflags` inject `BuildTime` and `DebugFlag` via `internal/buildinfo.go`
- HTMX for dynamic partial updates; middleware detects HX-Request headers
- GitHub OAuth for auth; admin determined by `ADMIN_EMAIL` env var

## LLM Rules

- Never add comments. 
- Do not remove comments you didn't add, unless you are removing the 
  associated code.
- Do not take shortcuts. Always do work correctly and completely.
